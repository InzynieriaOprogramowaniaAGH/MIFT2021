pipeline {

    agent any
    stages{

        stage('Build'){

            steps{
                echo 'Building app'
             
                git branch: 'Grupa02-KJ306450_Lab07', url: 'https://github.com/InzynieriaOprogramowaniaAGH/MIFT2021'
                dir('Grupy/Grupa02/IK297101/LAB07/Docker'){
                    
                    sh '''
                        curl -L "https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)" -o ~/docker-compose
                        chmod +x ~/docker-compose
                        ~/docker-compose up -d build-delta-chat
                    ''' 
                }
            }
        }
        
        stage('Test') {
            
            steps{
                echo 'Start testing'
                
                dir('Grupy/Grupa02/KJ306450/Lab07/Docker'){
                    sh '~/docker-compose up -d test-delta-chat'
                }
            }

            post {
                success {
                    emailext attachLog: true, 
                        body: "Test status: ${currentBuild.currentResult}: Job ${env.JOB_NAME}, More informations in attachment", 
                        recipientProviders: [developers()], 
                        subject: 'Test passed', 
                        to: 'kijek.igor@gmail.pl'
                }

                failure {
                    emailext attachLog: true, 
                        body: "Test status: ${currentBuild.currentResult}: Job ${env.JOB_NAME}, More informations in attachment", 
                        recipientProviders: [developers()], 
                        subject: 'Test failed', 
                        to: 'kijek.igor@gmail.pl'
                }
            }
        }
    }

    
    post {

        success {
            emailext attachLog: true, 
                body: "Pipeline status: ${currentBuild.currentResult}: Job ${env.JOB_NAME}, More informations in attachment", 
                recipientProviders: [developers()], 
                subject: 'Pipeline passed', 
                to: 'kijek.igor@gmail.pl'
        }

        failure {
            emailext attachLog: true, 
                body: "Pipeline status: ${currentBuild.currentResult}: Job ${env.JOB_NAME}, More informations in attachment", 
                recipientProviders: [developers()], 
                subject: 'Pipeline failed', 
                to: 'kijek.igor@gmail.pl'
        }
    }
}
